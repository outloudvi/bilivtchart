<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>VTuber Bilibili Rank</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
  <style>
    .ui.card {
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="ui grid">
    <div class="ui eight wide column">
      <div class="ui card">
        <div id="divCopyright">
          Data @ <a href="https://vtuber.magictea.cc/rank/vtuber">https://vtuber.magictea.cc/rank/vtuber</a>. Sorted by
          fans count. Made by <a href="https://github.com/outloudvi/bilivtchart">Outloudvi</a> w/ <a href="http://www.echartsjs.com">ECharts</a>.
        </div>
        <div>
          Showing data of the most subscribed <span id="clipAmount">100</span> livers.
        </div>
        <div>
          Only show the most-subscribed
          <div class="ui input">
            <input id="clipInput" type="text" value="100">
          </div>
          <button id="btnClip" class="ui button tiny">OK</button>

          <br>

          <div id="filterAiDiv" class="ui checkbox">
            <input id="filterAi" type="checkbox" tabindex="0" class="hidden">
            <label>Filter Kizuna Ai <span style="color: grey">(to make the graph more informative)</span></label>
          </div>
        </div>
      </div>
    </div>
    <div id="kaStatus" class="ui four wide column">
      Fetching data...
    </div>
    <div id="lastUpdate" class="ui two wide column">
      Last update:
    </div>
  </div>

  <div id="charts">
      <div id="main" class="player"></div>
      <div id="play" class="player"></div>
      <div id="incr" class="player"></div>
      <div id="trans" class="player"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@4.2.0-rc.2/dist/echarts.js"></script>
  <script>
    var CLIP_AMOUNT = 100;
    var KA_FILTER = false;
    var vtdataorig;

    $('.player').css('height', 300)
      .css('width', 0.95 * window.innerWidth)
      .css('margin', 'auto');

    $('.ui.checkbox').checkbox();

    var followChart = echarts.init(document.getElementById('main'));
    var playChart = echarts.init(document.getElementById('play'));
    var incrChart = echarts.init(document.getElementById('incr'));
    var transChart = echarts.init(document.getElementById('trans'));

    $('#btnClip').click(() => {
      CLIP_AMOUNT = Number($('#clipInput').val());
      drawMap();
      $('#clipAmount').text(CLIP_AMOUNT);
    });

    $('#filterAi').change(() => {
      KA_FILTER = $('#filterAiDiv').hasClass('checked');
      drawMap();
    });

    console.log("Fetching data from Magictea...");
    $.get('https://wt-ada99ae843c012425386e0b495883cbc-0.sandbox.auth0-extend.com/vtmtproxy', function (data) {
      console.log(data);
      vtdataorig = data.tables;
      console.log("Fetched.");
      drawMap();
      $('#lastUpdate').html(`
        Last update: <br>
        ${new Date(data.lastupd*1000).toString()}
      `);
      let ka = vtdataorig[0];
      let sec = vtdataorig[1];
      $('#kaStatus').html(`
      Kizuna Ai: <br>
            Sub +${ka.suber - sec.suber} than 2nd. (${((ka.suber - sec.suber) / sec.suber * 100).toFixed(2)}% more than 2nd) <br>
            View +${ka.totalplay - sec.totalplay} than 2nd. (${((ka.totalplay - sec.totalplay) / sec.totalplay * 100).toFixed(2)}% more than 2nd)
      `);
    });

    function doChart(data, text, chart, displayName, names) {
      chart.setOption(option = {
        title: {
          text: text
        },
        tooltip: {
          trigger: 'axis'
        },
        xAxis: {
          data: names,
          show: CLIP_AMOUNT < 9 ? true : false,
        },
        yAxis: {
          splitLine: {
            show: false
          }
        },
        toolbox: {
          left: 'center',
          feature: {
            dataZoom: {
              yAxisIndex: 'none'
            },
            restore: {},
            saveAsImage: {}
          }
        },
        series: {
          name: displayName,
          type: 'line',
          data: data,
          markLine: {
            silent: true,
            data: [{
              yAxis: 50
            }, {
              yAxis: 100
            }, {
              yAxis: 150
            }, {
              yAxis: 200
            }, {
              yAxis: 300
            }]
          }
        }
      });
    }

    function drawMap() {
      let vtdata = vtdataorig.slice(KA_FILTER ? 1 : 0, CLIP_AMOUNT);
      let names = vtdata.map(item => item.name);
      doChart(vtdata.map(item => item.totalplay), 'VTuber at Bilibili - Plays', playChart, 'Plays', names);
      doChart(vtdata.map(item => item.suber), 'VTuber at Bilibili - Subscribers', followChart, 'Subs', names);
      doChart(vtdata.map(item => item.incr), 'VTuber at Bilibili - Subscriber delta', incrChart, 'Sub delta', names);
      doChart(vtdata.map(item => item.suber / item.totalplay), 'VTuber at Bilibili - Sub per view', transChart, 'Sub per view', names);
    }
  </script>
</body>

</html>
