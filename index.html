<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>VTuber Bilibili Rank</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
  <style>
    .ui.card {
      width: 100%;
    }

    #immigrateHeader {
      display: none;
      margin: 1em 5em;
    }

    #divPanel {
      margin-left: 1em;
      padding: 1em;
    }

    #divTopline {
      margin: 1em;
    }
  </style>
</head>

<body>
  <div id="immigrateHeader">
    <div class="ui message">
      <i class="close icon"></i>
      <div class="header">We are migrating</div>
      <p>We are migrating to <a href="https://vtc.outv.im">vtc.outv.im</a>. outvi.ooo is at its sunset.</p>
    </div>
  </div>
  <div id="divTopline" class="ui grid">
    <div class="ui eight wide column">
      <div id="divPanel" class="ui card">
        <div id="divCopyright">
          Data @ <a href="https://vtuber.magictea.cc/rank/vtuber">https://vtuber.magictea.cc/rank/vtuber</a>. Sorted by
          fans count. Made by <a href="https://github.com/outloudvi/bilivtchart">Outloudvi</a> w/ <a
            href="http://www.echartsjs.com">ECharts</a>.
        </div>
        <div>
          Showing data of the most subscribed <span id="clipAmount">100</span> livers.
        </div>
        <div>
          Only show the most-subscribed
          <div class="ui input">
            <input id="clipInput" type="text" value="100">
          </div>
          <button id="btnClip" class="ui button tiny">OK</button>

          <br>

          <div id="filterAiDiv" class="ui checkbox">
            <input id="filterAi" type="checkbox" tabindex="0" class="hidden">
            <label>Filter Kizuna Ai <span style="color: grey">(to make the graph more informative)</span></label>
          </div>
        </div>
      </div>
    </div>
    <div id="kaStatus" class="ui four wide column">
      Fetching data...
    </div>
    <div id="lastUpdate" class="ui two wide column">
      Last update:
    </div>
  </div>

  <div id="charts">
    <div id="main" class="player"></div>
    <div id="play" class="player"></div>
    <div id="incr" class="player"></div>
    <div id="trans" class="player"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@4.2.0-rc.2/dist/echarts.js"></script>
  <script>
    var CLIP_AMOUNT = 100;
    var KA_FILTER = false;
    var vtdataorig;

    $('.player').css('height', 300)
      .css('width', 0.95 * window.innerWidth)
      .css('margin', 'auto');

    $('.ui.checkbox').checkbox();

    var followChart = echarts.init(document.getElementById('main'));
    var playChart = echarts.init(document.getElementById('play'));
    var incrChart = echarts.init(document.getElementById('incr'));
    var transChart = echarts.init(document.getElementById('trans'));

    $('#btnClip').click(() => {
      CLIP_AMOUNT = Number($('#clipInput').val());
      drawMap();
      $('#clipAmount').text(CLIP_AMOUNT);
    });

    $('#filterAi').change(() => {
      KA_FILTER = $('#filterAiDiv').hasClass('checked');
      drawMap();
    });

    console.log("Fetching data from Magictea...");
    $.get('https://wt-ada99ae843c012425386e0b495883cbc-0.sandbox.auth0-extend.com/vtmtproxy', function (data) {
      console.log(data);
      vtdataorig = data.tables;
      console.log("Fetched.");
      drawMap();
      $('#lastUpdate').html(`
        Last update: <br>
        ${new Date(data.lastupd * 1000).toString()}
      `);
      let ka = vtdataorig[0];
      let sec = vtdataorig[1];
      $('#kaStatus').html(`
      Kizuna Ai: <br>
            Sub +${ka.suber - sec.suber} than 2nd. (${((ka.suber - sec.suber) / sec.suber * 100).toFixed(2)}% more than 2nd) <br>
            View +${ka.totalplay - sec.totalplay} than 2nd. (${((ka.totalplay - sec.totalplay) / sec.totalplay * 100).toFixed(2)}% more than 2nd)
      `);
      showInterestingStats();
    });

    function doChart(data, text, chart, displayName, names) {
      chart.setOption(option = {
        title: {
          text: text
        },
        tooltip: {
          trigger: 'axis'
        },
        xAxis: {
          data: names,
          show: CLIP_AMOUNT < 9 ? true : false,
        },
        yAxis: {
          splitLine: {
            show: false
          }
        },
        toolbox: {
          left: 'center',
          feature: {
            dataZoom: {
              yAxisIndex: 'none'
            },
            restore: {},
            saveAsImage: {}
          }
        },
        series: {
          name: displayName,
          type: 'line',
          data: data
        }
      });
    }

    function drawMap() {
      let vtdata = vtdataorig.slice(KA_FILTER ? 1 : 0, CLIP_AMOUNT);
      let names = vtdata.map(item => item.name);
      doChart(vtdata.map(item => item.totalplay), 'VTuber at Bilibili - Plays', playChart, 'Plays', names);
      doChart(vtdata.map(item => item.suber), 'VTuber at Bilibili - Subscribers', followChart, 'Subs', names);
      doChart(vtdata.map(item => item.incr), 'VTuber at Bilibili - Subscriber delta', incrChart, 'Sub delta', names);
      doChart(vtdata.filter(item => item.mid !== 314062600).map(item => item.suber / item.totalplay), 'VTuber at Bilibili - Sub per view', transChart, 'Sub per view', names);
      // Emitted mid=314062600 (游戏部同好会) due to its disbandment.
    }

    function showInterestingStats() {
      let say = function (x) { console.log('%c' + x, 'font: Roboto; color: #1ab2ff'); };
      let totalPlay = 0; for (i of vtdataorig.map(obj => obj.totalplay)) totalPlay += i;
      let totalSub = 0; for (i of vtdataorig.map(obj => obj.suber)) totalSub += i;

      say("--- Interesting stats of the top 100 subscribed vtubers ---");
      say(` Total play: ${totalPlay}`);
      say(` Total sub: ${totalSub} (not deduplicated)`);
      say(`--- Detailed stats of the top 10 subscribed vtubers     ---`);

      let dataTable = {};

      for (let _i = 0; _i <= 9; _i++) {
        let per = {};
        let ctx = vtdataorig[_i];
        //say(` #${_i+1}: ${ctx.name}, ${ctx.suber}(${(100*ctx.suber/totalSub).toFixed(2)}%) suber, ${ctx.totalplay}(${(100*ctx.totalplay/totalPlay).toFixed(2)}%) views`)
        per.name = ctx.name;
        per.suber = ctx.suber
        // per.subPercent = Number((100*ctx.suber/totalSub).toFixed(2))
        per.views = ctx.totalplay
        // per.viewPercent = Number((100*ctx.totalplay/totalPlay).toFixed(2))
        dataTable[_i + 1] = per
      }

      console.table(dataTable);

      console.log(`旅老师女装关注数进度： ${vtdataorig.find(x => x.mid === 54081).suber}/100000`)
      console.log("  详情 -> https://t.bilibili.com/223076246263616135")
    }

    $('.message .close')
      .on('click', function () {
        $(this)
          .closest('.message')
          .transition('fade')
          ;
      })
      ;

    if (window.location.hostname !== "vtc.outv.im") {
      $('#immigrateHeader').show();
    }
  </script>
</body>

</html>